# -*- coding: utf-8 -*-
"""ë¦¬í¬íŠ¸_ìµœì¢….ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/19V_gAn8cDAy7wjaOTcg7hjPdyZYZm5ho

#ë°ì´í„° ë§ˆìš´íŠ¸
"""

# pymysql

import pandas as pd
import plotly.express as px
import plotly.io as pio

from google.colab import drive
drive.mount('/content/drive')

df_store = pd.read_sql_table('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¡á†¼á„€á…¯á†«-á„‹á…¥á†¸á„‰á…©(á„‹á…¥á†¸á„Œá…©á†¼á„ƒá…¢á„‡á…®á†«á„…á…²+á„’á…¢á†¼á„Œá…¥á†¼á„ƒá…©á†¼á„á…®á„€á…¡).csv', encoding='UTF8')
df_facility = pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¡á†¼á„€á…¯á†«-á„Œá…µá†¸á„€á…¢á†¨á„‰á…µá„‰á…¥á†¯(á„’á…¢á†¼á„Œá…¥á†¼á„ƒá…©á†¼á„á…®á„€á…¡+á„€á…§á†¯á„á…³á†¨á„á…µá„á…¥á„…á…µ).csv', encoding='UTF8')
df_area = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¥á„‹á…®á†¯á„‰á…µ á„‰á…¡á†¼á„€á…¯á†«á„‡á…®á†«á„‰á…¥á†¨á„‰á…¥á„‡á…µá„‰á…³(á„‰á…¡á†¼á„€á…¯á†«á„‹á…§á†¼á„‹á…§á†¨)_á„‰á…®á„Œá…¥á†¼á„‡á…©á†«.csv", encoding= 'CP949')
df_shops = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¥á„‹á…®á†¯á„‰á…µ á„‰á…¡á†¼á„€á…¯á†«á„‡á…®á†«á„‰á…¥á†¨á„‰á…¥á„‡á…µá„‰á…³(á„‰á…¡á†¼á„€á…¯á†«-á„Œá…¥á†·á„‘á…©).csv", encoding= 'CP949')
df_sales = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¥á„‹á…®á†¯á„‰á…µ á„‰á…¡á†¼á„€á…¯á†«á„‡á…®á†«á„‰á…¥á†¨á„‰á…¥á„‡á…µá„‰á…³(á„‰á…¡á†¼á„€á…¯á†«-á„á…®á„Œá…¥á†¼á„†á…¢á„á…®á†¯).csv", encoding= 'CP949')
df_income_consume = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¥á„‹á…®á†¯á„‰á…µ á„‰á…¡á†¼á„€á…¯á†«á„‡á…®á†«á„‰á…¥á†¨á„‰á…¥á„‡á…µá„‰á…³(á„‰á…¡á†¼á„€á…¯á†«-á„‰á…©á„ƒá…³á†¨á„‰á…©á„‡á…µ).csv", encoding= 'CP949')
df_total_sales = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„Œá…µá„á…®á†¯_á„á…©á†¼á„€á…³á†·á„‹á…¢á†¨_á„‚á…¥á†¯á„€á…¡á†¹á„á…¥á„…á…µ_á„‹á…ªá†«á„…á…­.csv", encoding= 'CP949')
df_map_info = pd.read_csv("/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„’á…¢á†¼á„Œá…¥á†¼á„ƒá…©á†¼+á„‰á…¡á†¼á„€á…¯á†«+á„‰á…µá„€á…®á†«á„€á…®_á„á…©á†¼á„’á…¡á†¸á„‡á…©á†«.csv", encoding= 'CP949')
df_rs_population = pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¡á†¼á„Œá…®á„‹á…µá†«á„€á…® - á„á…¬á„Œá…©á†¼á„‡á…©á†«.csv', encoding='euc-kr')
df_rs_income = pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¡á†¼á„Œá…®á„‹á…µá†«á„€á…® - á„‰á…©á„ƒá…³á†¨á„‰á…©á„‡á…µ.csv', encoding='euc-kr')
df_lifepop = pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¢á†¼á„’á…ªá†¯á„‹á…µá†«á„€á…®+á„’á…¢á†¼á„Œá…¥á†¼á„ƒá…©á†¼+á„‰á…¡á†¼á„€á…¯á†«+á„‰á…µá„€á…®á†«á„€á…®.csv', encoding='UTF8')
df_workpop =  pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„Œá…µá†¨á„Œá…¡á†¼á„‹á…µá†«á„€á…®+á„’á…¢á†¼á„Œá…¥á†¼á„ƒá…©á†¼+á„‰á…¡á†¼á„€á…¯á†«+á„‰á…µá„€á…®á†«á„€á…®_á„á…¥á†¯á„…á…¥á†·á„†á…§á†¼á„‰á…®á„Œá…¥á†¼.csv', encoding='UTF8')
df_apart = pd.read_csv('/content/drive/MyDrive/[á„á…¬á„Œá…©á†¼á„‘á…³á„…á…©á„Œá…¦á†¨á„á…³]_á„‹á…®á„…á…µFISA/á„ƒá…¦á„‹á…µá„á…¥ á„‡á…®á†«á„‰á…¥á†¨/á„‰á…¡á†¼á„€á…¯á†«-á„‹á…¡á„‘á…¡á„á…³.csv(á„á…¬á„Œá…©á†¼á„‰á…®á„Œá…¥á†¼)', encoding='UTF8')

"""#ì•„íŒŒíŠ¸ë¶„ì„"""

def analyze_apt(dong_code):

  print(avg_apartment_prices(dong_code))

  visualize_avg_apt_prices(dong_code)

  print(less_than_66(dong_code))

  visualize_less_than_66(dong_code)

analyze_apt(11545710)

"""###ë¶„ì„5: í•´ë‹¹ ë™ì˜ ê°€ì¥ ìµœê·¼(2022) ì•„íŒŒíŠ¸ í‰ê·  ê°€ê²© ë° 6ì–µ ì´ìƒ ì•„íŒŒíŠ¸ ë¹„ìœ¨"""

def avg_apartment_prices(dong_code):
    # ì…ë ¥ ë°›ì€ í–‰ì •ë™ ëª…ì— í•´ë‹¹í•˜ëŠ” í–‰ì„ í•„í„°ë§
    dong_row = df_apart[df_apart['dong_code'] == dong_code]

    if dong_row.empty:
        return "í–‰ì •ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

    # í•´ë‹¹ í–‰ì •ë™ì˜ 2022ë…„ í‰ê·  ì•„íŒŒíŠ¸ ê°€ê²©ì„ ê³„ì‚°
    avg_price_2022 = dong_row[dong_row['year'] == 2022]['avg_price'].mean()

    # í•´ë‹¹ í–‰ì •ë™ì˜ 6ì–µ ì´ìƒ ì•„íŒŒíŠ¸ ë¹„ìœ¨ì„ ê³„ì‚°
    total_apartments = dong_row[dong_row['year'] == 2022]['~1'] + dong_row[dong_row['year'] == 2022]['1~2'] + dong_row[dong_row['year'] == 2022]['2~3'] + dong_row[dong_row['year'] == 2022]['3~4'] + dong_row[dong_row['year'] == 2022]['4~5'] + dong_row[dong_row['year'] == 2022]['5~6'] + dong_row[dong_row['year'] == 2022]['6~']
    apartments_over_6 = dong_row[dong_row['year'] == 2022]['6~']
    over_6_ratio = apartments_over_6.sum() / total_apartments.sum()

    # ê²°ê³¼ ì¶œë ¥
    result = f"í•´ë‹¹ í–‰ì •ë™ì˜ 2022ë…„ í‰ê·  ì•„íŒŒíŠ¸ ê°€ê²©: {avg_price_2022:,.2f}ì›"
    result += f"\ní•´ë‹¹ í–‰ì •ë™ì˜ 2022ë…„ 6ì–µ ì´ìƒ ì•„íŒŒíŠ¸ ë¹„ìœ¨: {over_6_ratio:.2%}"

    return result

"""### ë¶„ì„6: í•´ë‹¹ ë™ì˜ ì•„íŒŒíŠ¸ ê°€ê²© ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜

"""

# í–‰ì •ë™ ì½”ë“œ ì…ë ¥ ì‹œ, í•´ë‹¹ ë™ì˜ ì•„íŒŒíŠ¸ ê°€ê²© ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
def visualize_avg_apt_prices(dong_code):
    year_quarter = []
    list_num = []
    for year in  range(2017,2023):
        for quarter in range(1, 5):
            filtered_df = df_apart[
            (df_apart['dong_code'] == dong_code) &
            (df_apart['year'] == year) &
            (df_apart['quarter'] == quarter)
            ]


            # filtered_dfì—ì„œ ì•„íŒŒíŠ¸ ê°€ê²© í‰ê·  êµ¬í•¨
            avg_price_sum = filtered_df['avg_price'].sum()
            list_num.append(avg_price_sum)
            year_quarter.append(f'{str(year), str(quarter)}')

    # ê·¸ë˜í”„ xì¶•, yì¶•, title ì§€ì •
    fig = px.line(x=year_quarter, y=list_num,
                title=f"í•´ë‹¹ í–‰ì •ë™ì˜ ì•„íŒŒíŠ¸ ê°€ê²© ë³€í™” ì¶”ì´")

    fig.update_layout(yaxis_tickformat=",.0f")

    # ê·¸ë˜í”„ ì»¤ìŠ¤í„° ë§ˆì´ì§•
    fig.update_layout(xaxis_title="ë¶„ê¸°", yaxis_title="ì•„íŒŒíŠ¸ ê°€ê²© ë³€í™”")

    return fig.show()

"""### ë¶„ì„ 7: í•´ë‹¹ ë™ì˜ ê°€ì¥ ìµœê·¼(2022) 66ã¡(ì•½ 20í‰) ë¯¸ë§Œ ë¹„ìœ¨ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜

"""

# í–‰ì •ë™ëª… ì…ë ¥ ë°›ì„ ì‹œ, í•´ë‹¹ ë™ì˜ ê°€ì¥ ìµœê·¼(2022) 66ã¡(ì•½ 20í‰) ë¯¸ë§Œ ë¹„ìœ¨ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜

def less_than_66(dong_code):
  dong_row = df_apart[df_apart['dong_code'] == dong_code]

  if dong_row.empty:
    return "í–‰ì •ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

  # í•´ë‹¹ í–‰ì •ë™ì˜ 2022ë…„ 1ì¸ ê°€êµ¬ ë¹„ìœ¨ì„ ê³„ì‚°
  total_apartments = dong_row[dong_row['year'] == 2022]['~66sm'] + dong_row[dong_row['year'] == 2022]['66~99sm'] + dong_row[dong_row['year'] == 2022]['99~132sm'] + dong_row[dong_row['year'] == 2022]['132~165sm'] + dong_row[dong_row['year'] == 2022]['165sm~']
  apartment_less_than_66 = dong_row[dong_row['year'] == 2022]['~66sm']
  less_than_ratio = apartment_less_than_66.sum() / total_apartments.sum()

  result = f"í•´ë‹¹ í–‰ì •ë™ì˜ 66ã¡ ë¯¸ë§Œ ì•„íŒŒíŠ¸ ë¹„ìœ¨: {less_than_ratio:.2%}"

  return result

"""###ë¶„ì„ 8: í•´ë‹¹ ë™ì˜ 20í‰ ë¯¸ë§Œ ì•„íŒŒíŠ¸ ê°œìˆ˜ ì¶”ì´"""

# í–‰ì •ë™ ì½”ë“œ ì…ë ¥ ì‹œ, í•´ë‹¹ ë™ì˜ 20í‰ ë¯¸ë§Œ ì•„íŒŒíŠ¸ ê°œìˆ˜ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
def visualize_less_than_66(dong_code):
    year_quarter = []
    list_num = []
    for year in  range(2017,2023):
        for quarter in range(1, 5):
            filtered_df = df_apart[
            (df_apart['dong_code'] == dong_code) &
            (df_apart['year'] == year) &
            (df_apart['quarter'] == quarter)
            ]


            # filtered_dfì—ì„œ ì•„íŒŒíŠ¸ ê°€ê²© í‰ê·  êµ¬í•¨
            sm_sum = filtered_df['~66sm'].sum()
            list_num.append(sm_sum)
            year_quarter.append(f'{str(year), str(quarter)}')

    # ê·¸ë˜í”„ xì¶•, yì¶•, title ì§€ì •
    fig = px.line(x=year_quarter, y=list_num,
                title=f"í•´ë‹¹ í–‰ì •ë™ì˜ 66ã¡(ì•½ 20í‰) ë¯¸ë§Œ ì•„íŒŒíŠ¸ ê°œìˆ˜ ì¶”ì´")

    fig.update_layout(yaxis_tickformat=",.0f")

    # ê·¸ë˜í”„ ì»¤ìŠ¤í„° ë§ˆì´ì§•
    fig.update_layout(xaxis_title="ë¶„ê¸°", yaxis_title="66ã¡ ë¯¸ë§Œ ì•„íŒŒíŠ¸ ê°œìˆ˜ ë³€í™”")

    return fig.show()

"""# 1. í™˜ê²½ë¶„ì„

###ìµœì¢…ë¶„ì„
"""

dong_code = 11545710  # ì‹œí¥ 5ë™
year=2022
quarter = 1
job_code = 'ì™¸ì‹ì—…'

# ì·¨í•©
import plotly.express as px

def analyze_env(dong_code, job_code):

  zone_num(dong_code)

  store_num(dong_code)

  store_num_trend(dong_code, job_code)

  by_loc(dong_code)

  facility_num(dong_code)

"""### ë¶„ì„0: í–‰ì •ë™ë³„ ìƒê¶Œì˜ ê°œìˆ˜"""

def zone_num(dong_code):
  df_zone = df_store[df_store['í–‰ì •ë™_ì½”ë“œ']==dong_code]
  a = df_zone[('ìƒê¶Œ_ì½”ë“œ')].nunique()
  b = df_zone[('ìƒê¶Œ_ì½”ë“œ_ëª…')].unique()
  print(f"í•´ë‹¹ í–‰ì •ë™ì—ëŠ” ì´ {a}ê°œì˜ ìƒê¶Œì´ ìˆìŠµë‹ˆë‹¤. ëª©ë¡: {b}")

"""### ë¶„ì„1: í–‰ì •ë™ ë‚´ ì—…ì¢… ëŒ€ë¶„ë¥˜ë³„ ì—…ì†Œ ìˆ˜"""

def store_num(dong_code):
  #ë™ì½”ë“œ í•„í„°ëœ df_temp dataframe
  df_temp = df_store[df_store['í–‰ì •ë™_ì½”ë“œ']==dong_code]
  #ì—…ì¢…ë³„ ì í¬ìˆ˜ì˜ í•©
  df_filtered = df_temp.groupby(['ì—…ì¢…_ëŒ€ë¶„ë¥˜'])[['ì í¬_ìˆ˜']].sum().squeeze()

  colors = ["ì„œë¹„ìŠ¤ì—…", "ì†Œë§¤ì—…", "ì™¸ì‹ì—…"]
  for template in ["simple_white"]:
  #plotly barchart ìƒì„±
    fig = px.bar(df_filtered, color=colors,
      color_discrete_map={
                "ì„œë¹„ìŠ¤ì—…": "rgb(190,168,218)",
                "ì†Œë§¤ì—…": "rgb(251,128,114)",
                "ì™¸ì‹ì—…": "rgb(141,211,199)"
                }
                 ,template=template)

  #ë°”ì°¨íŠ¸ ì œëª©, xì¶•, yì¶• í…ìŠ¤íŠ¸ ì¶”ê°€
  fig.update_layout(title_text= "ì—…ì¢…ë³„ ì í¬ ìˆ˜")
  fig.update_xaxes(title_text='ì—…ì¢…')
  fig.update_yaxes(title_text='ì í¬ ìˆ˜')

  # ë§‰ëŒ€ ë‘ê»˜ ì¡°ì •
  fig.update_layout(bargap=0.7)

  #figure ì‹¤í–‰
  fig.show()

store_num(dong_code)

"""### ë¶„ì„2: í–‰ì •ë™ ë‚´ ì—…ì¢… ëŒ€ë¶„ë¥˜ë³„ ì—…ì†Œ ìˆ˜ 3ë…„ê°„ ì¶”ì´
ì§€ì—­+ì—…ì¢… ì„ íƒì‹œ ë³´ì—¬ì£¼ëŠ” ì‹œê³„ì—´ ë°ì´í„°
"""

import pandas as pd
import plotly.express as px

def store_num_trend(dong_code, job_code):
  df_filtered= df_store[(df_store['í–‰ì •ë™_ì½”ë“œ']==dong_code) &
    (df_store['ì—…ì¢…_ëŒ€ë¶„ë¥˜'] == job_code)]
  df = df_filtered.groupby(['ê¸°ì¤€_ë…„_ì½”ë“œ', 'ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'])[['ì í¬_ìˆ˜']].sum()
  x=list(range(12))

  for i in range(12):
    x[i]=(f'202{i//4}'+'_'+f'{(i%4)+1}')
  colors = ['ì í¬ ìˆ˜']
  for template in ["simple_white"]:
    fig = px.line(df, x=x, y='ì í¬_ìˆ˜',
              labels={'ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ': 'ë¶„ê¸°', 'ì í¬_ìˆ˜': 'ì í¬ ìˆ˜'},
              title='ë¶„ê¸°ë³„ ì—…ì†Œ ìˆ˜ ì¶”ì´',
              template=template)
  fig.update_xaxes(title_text='ì‹œê¸°')
  fig.update_traces(line_width=4,line_dash='dash',line_color='rgb(128,177,211)')
  fig.show()

store_num_trend(dong_code, 'ì™¸ì‹ì—…')

"""###ë¶„ì„3 : í–‰ì •ë™ë³„ ê°€ì¥ ì í¬ìˆ˜ê°€ ë§ì€ ì—…ì¢… ë¶„ì„"""

def by_loc(dong_code):
  def service_max(i):
    return i.value_counts().index[0]
  df_temp = df_store[df_store['í–‰ì •ë™_ì½”ë“œ']==dong_code]
  a = df_temp.groupby('í–‰ì •ë™ëª…').agg({'ì í¬_ìˆ˜' : 'max', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ_ëª…_x': service_max}).reset_index()
  return print(f"{a['í–‰ì •ë™ëª…'].iloc[0]}ì˜ ê°€ì¥ ë§ì€ ì—…ì¢…ì€ {a['ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ_ëª…_x'].iloc[0]}ì´ë©° ì´ {a['ì í¬_ìˆ˜'].iloc[0]}ê°œì˜ ì í¬ê°€ ìˆìŠµë‹ˆë‹¤")

"""### ë¶„ì„4: ì£¼ìš” ì‹œì„¤ í˜„í™©"""

# 1. best3ì˜ ìƒ‰ê¹”ì€ ë‹¤ë¥´ê²Œ ë‚˜íƒ€ë‚˜ë„ë¡..
# 2. ì¸ê·¼ í–‰ì •ë™ê³¼ ë¹„êµí•´ë„ ì¢‹ì„ë“¯

import plotly.express as px

def facility_num(dong_code):
  df_filtered_1 = df_facility.loc[(df_facility['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2022) & (df_facility['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == 4) & (df_facility['í–‰ì •ë™_ì½”ë“œ'] == dong_code)].groupby(['í–‰ì •ë™ëª…'])[['ê´€ê³µì„œ_ìˆ˜', 'ì€í–‰_ìˆ˜', 'ì¢…í•©ë³‘ì›_ìˆ˜', 'ì¼ë°˜_ë³‘ì›_ìˆ˜', 'ì•½êµ­_ìˆ˜', 'ìœ ì¹˜ì›_ìˆ˜',
       'ì´ˆë“±í•™êµ_ìˆ˜', 'ì¤‘í•™êµ_ìˆ˜', 'ê³ ë“±í•™êµ_ìˆ˜', 'ëŒ€í•™êµ_ìˆ˜', 'ë°±í™”ì _ìˆ˜', 'ìŠˆí¼ë§ˆì¼“_ìˆ˜', 'ê·¹ì¥_ìˆ˜',
       'ìˆ™ë°•_ì‹œì„¤_ìˆ˜', 'ê³µí•­_ìˆ˜', 'ì² ë„_ì—­_ìˆ˜', 'ë²„ìŠ¤_í„°ë¯¸ë„_ìˆ˜', 'ì§€í•˜ì² _ì—­_ìˆ˜', 'ë²„ìŠ¤_ì •ê±°ì¥_ìˆ˜']].sum().squeeze()
  for template in ["simple_white"]:
    fig = px.bar(data_frame=df_filtered_1, color_discrete_sequence=px.colors.qualitative.Set3, template=template)

  #ë°”ì°¨íŠ¸ ì œëª©, xì¶•, yì¶• í…ìŠ¤íŠ¸ ì¶”ê°€
  fig.update_layout(title_text= "ì„ íƒì§€ì—­ì˜ ì—…ì¢… ëŒ€ë¶„ë¥˜ë³„ ì—…ì†Œ ìˆ˜")
  fig.update_xaxes(title_text='ì—…ì¢… ë¶„ë¥˜')
  fig.update_yaxes(title_text='ê°œìˆ˜')

  #figure ì‹¤í–‰
  fig.show()

"""### ë¶„ì„5:

### ìµœì¢…ë¶„ì„ ì‹¤í–‰
"""

analyze_env(11680580, 'ì™¸ì‹ì—…')

"""# 2. ë§¤ì¶œë¶„ì„ (ì •ë¦¬ì˜ˆì‹œ)ğŸ’›ğŸ§¡ğŸ’š"""

dong_code = 11545710  # ì‹œí¥ 5ë™
year = 2022
quarter = 1

"""###ìµœì¢…ë¶„ì„"""

import plotly.express as px
def analyze_sales(dong_code, year, quarter):
  global df_map_info

  ################ ìš”ì¼ë³„ ë§¤ì¶œ ë¹„êµ ################
  compare_sales_by_day(dong_code, year, quarter)

  ################ ì´ ë§¤ì¶œ ë‚´ìš© ################
  print_total_sales(dong_code)

  ################ ë¶„ë¥˜ë³„ ì§€ì¶œ ë¹„ìœ¨ ################
  show_sales_rate(dong_code)



"""### ë¶„ì„ 1 : ìš”ì¼ë³„ ë§¤ì¶œ ë¹„êµ"""

def compare_sales_by_day(dong_code, year, quarter):
  dong_info = df_map_info.loc[(df_map_info['í–‰ì •ë™_ì½”ë“œ']==dong_code)].drop(columns=['ì—‘ìŠ¤ì¢Œí‘œ_ê°’', 'ì™€ì´ì¢Œí‘œ_ê°’'])
  df_dong_sales = pd.merge(left=dong_info, right=df_sales, how='left', \
                  on=['ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…', 'ìƒê¶Œ_ì½”ë“œ_ëª…'], sort=False)
  df_dong_sales_code = df_dong_sales.loc[(df_dong_sales['í–‰ì •ë™_ì½”ë“œ']==dong_code)]

  # ì‹œê°„ ì¡°ê±´1 ì •ì˜
  cond1 = (df_dong_sales['ê¸°ì¤€_ë…„_ì½”ë“œ']==year)

  # ì‹œê°„ ì¡°ê±´2 ì •ì˜
  cond2 = (df_dong_sales['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ']==quarter)

  df_dong_sales_set_time = df_dong_sales[cond1 & cond2]

  df_result = pd.DataFrame({})

  for code in dong_info['ìƒê¶Œ_ì½”ë“œ']:
    df = df_dong_sales_set_time.loc[df_dong_sales_set_time['ìƒê¶Œ_ì½”ë“œ']==code]
    df_top = df.sort_values(by=['ë¶„ê¸°ë‹¹_ë§¤ì¶œ_ê¸ˆì•¡'], axis=0).iloc[0]
    df_top = pd.DataFrame(df_top).T
    df_result = pd.concat([df_result, df_top], ignore_index = True)

  line_chart_title = f'{df["í–‰ì •ë™ëª…"].iloc[0]}ì˜ ìƒê¶Œë³„ ìµœëŒ€ ë§¤ì¶œ ì—…ì¢… ìš”ì¼ ë³„ ë¹„êµ ì¶”ì´'
  df_result.iloc[:, 16:23].columns = list(map(lambda x:x[:-8], df_result.iloc[:,16:23].columns))
  df_real_result = df_result.iloc[:, 16:23]
  df_real_result.columns = list(map(lambda x:x[:-8], df_result.iloc[:,16:23].columns))
  df_real_result.index = df_result['ìƒê¶Œ_ì½”ë“œ_ëª…']
  df_real_result.T
  for template in ["simple_white"]:
    fig = px.line(data_frame= df_real_result.T, title=line_chart_title, template=template)

    fig.update_traces(line_width=5)
  fig.show()

"""### ë¶„ì„ 2: ì´ ë§¤ì¶œ ë‚´ìš©"""

def print_total_sales(dong_code):

  dong_info = df_map_info.loc[(df_map_info['í–‰ì •ë™_ì½”ë“œ']==dong_code)].drop(columns=['ì—‘ìŠ¤ì¢Œí‘œ_ê°’', 'ì™€ì´ì¢Œí‘œ_ê°’'])
  df_dong_total_sales = df_total_sales[df_total_sales['í–‰ì •ë™_ì½”ë“œ']==dong_code]
  df_dong_income_consume = pd.merge(left=dong_info, right=df_income_consume, how='left', \
                on=['ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…', 'ìƒê¶Œ_ì½”ë“œ_ëª…'], sort=False)
  dong_consume_avg = df_dong_income_consume['ì§€ì¶œ_ì´ê¸ˆì•¡'].sum()/df_dong_income_consume['ì§€ì¶œ_ì´ê¸ˆì•¡'].count()
  dong_sales_avg = df_dong_total_sales['ì§€ì¶œ_ì´ê¸ˆì•¡'].sum()/df_dong_total_sales['ì§€ì¶œ_ì´ê¸ˆì•¡'].count()
  seoul_sales_avg = df_total_sales['ì§€ì¶œ_ì´ê¸ˆì•¡'].sum()/df_total_sales['ì§€ì¶œ_ì´ê¸ˆì•¡'].count() # ê³„ì‚° ì „ ê°€ìƒì˜ ê°’, ì „ì²´ ë°ì´í„°ì…‹ì˜ ì§€ì¶œì— nullê°’ì´ ìˆë‹¤ê³  í•´ì„œ ê³„ì‚° ëª» í•œ ìƒíƒœ
  print(f"\n ì›” í‰ê·  ì§€ì¶œ ê¸ˆì•¡ì€ {dong_consume_avg} ì…ë‹ˆë‹¤. ì„œìš¸ì‹œ í‰ê· ì€ {seoul_sales_avg} ì…ë‹ˆë‹¤. \n")

"""### ë¶„ì„ 3: ë¶„ë¥˜ë³„ ì§€ì¶œ ë¹„ìœ¨"""

def show_sales_rate(dong_code):
  dong_info = df_map_info.loc[(df_map_info['í–‰ì •ë™_ì½”ë“œ']==dong_code)].drop(columns=['ì—‘ìŠ¤ì¢Œí‘œ_ê°’', 'ì™€ì´ì¢Œí‘œ_ê°’'])
  df_dong_sales = pd.merge(left=dong_info, right=df_sales, how='left', \
                  on=['ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…', 'ìƒê¶Œ_ì½”ë“œ_ëª…'], sort=False)
  df_dong_income_consume = pd.merge(left=dong_info, right=df_income_consume, how='left', \
                  on=['ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…', 'ìƒê¶Œ_ì½”ë“œ_ëª…'], sort=False)
  # ì‹œê°„ ì¡°ê±´1 ì •ì˜
  cond1 = (df_dong_income_consume['ê¸°ì¤€_ë…„_ì½”ë“œ']==year)

  # ì‹œê°„ ì¡°ê±´2 ì •ì˜
  cond2 = (df_dong_income_consume['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ']==quarter)
  df_dong_income_consume = df_dong_income_consume[cond1 & cond2]
  total_consume_by_sector = df_dong_income_consume.iloc[:, -9:]

  ratio = list(total_consume_by_sector.sum()/total_consume_by_sector.count()) # í‰ê· 
  labels = list(map(lambda x: x[:-7], total_consume_by_sector.columns))

  pie_chart_title = f"{df_dong_income_consume['í–‰ì •ë™ëª…'].iloc[0]} ì˜ ë¶„ë¥˜ë³„ ì§€ì¶œ ì´ê¸ˆì•¡ ë¹„ìœ¨"

  fig = px.pie(values = ratio, names=labels, title=pie_chart_title)

  fig.show()

"""### ìµœì¢…ë¶„ì„ ì‹¤í–‰"""

analyze_sales(dong_code, year, quarter)

"""# 3. ì¸êµ¬ë¶„ì„

## ğŸ”°ì¸êµ¬ ì·¨í•© ìµœì¢…ğŸ”°
"""

def analyze_pop(year, quarter, dong_code):
  #ìƒì£¼ì¸êµ¬
  summary_rspop(dong_code)
  #ìƒí™œì¸êµ¬
  get_lifepop_info(year, quarter, dong_code)
  get_genlifepop_info(year, quarter, dong_code)
  get_lifepop_age(year, quarter, dong_code)
  get_lifepop_time(year, quarter, dong_code)
  get_lifepop_day(year, quarter, dong_code)
  get_lifepop_recent(dong_code)
  get_lifepop_line(dong_code)
  #ì§ì¥ì¸êµ¬
  get_workpop_info(year, quarter, dong_code)

analyze_pop(2022, 4, 11680580)

"""## ìƒì£¼ì¸êµ¬

###ìµœì¢… ë¶„ì„
"""

def summary_rspop(dong_code):
  global df_map_info

  ################ ì´ ì£¼ê±°ì¸êµ¬ ìˆ˜(í…ìŠ¤íŠ¸) ################
  total_rspop(dong_code)

  ################ ì´ ì£¼ê±°ì¸êµ¬ ìˆ˜(ë¶„ê¸°ë³„ ë¼ì¸ê·¸ë˜í”„) ################
  total_rspop_line(dong_code)

  ################ ì£¼ê±°ì¸êµ¬ ì„±ë³„, ì—°ë ¹ëŒ€ë³„ 1ìœ„ ################
  max_rspop(dong_code)

  ################ ì´ ê°€êµ¬ ì„¸ëŒ€ ìˆ˜(ë¶„ê¸°ë³„ ë¼ì¸ê·¸ë˜í”„) ################
  total_household_line(dong_code)

  ################ ì´ ê°€êµ¬ ì„¸ëŒ€ ìˆ˜(í…ìŠ¤íŠ¸) ################
  total_household(dong_code)

  ################ í–‰ì •ë™ë³„ ì†Œë“êµ¬ê°„ ################
  income_avg(dong_code)

"""###ë¶„ì„0: í–‰ì •ë™ë³„ ì£¼ê±°ì¸êµ¬ ìˆ˜"""

# í–‰ì •ë™ë³„ ì£¼ê±°ì¸êµ¬ ìˆ˜(í…ìŠ¤íŠ¸)
# input: í–‰ì •ë™ì½”ë“œ, ê¸°ì¤€ë…„ì½”ë“œ, ê¸°ì¤€ë¶„ê¸°ì½”ë“œ

def total_rspop(dong_code):
# í–‰ì •ë™_ì½”ë“œ, ê¸°ì¤€_ë…„_ì½”ë“œ, ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œê°€ ê°™ì€ í–‰ë¼ë¦¬ filtered_df ë°ì´í„°í”„ë ˆì„ ìƒì„±
  filtered_df = df_rs_population[
    (df_rs_population['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
    (df_rs_population['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2022) &
    (df_rs_population['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == 4)
]
# filtered_dfì—ì„œ ì´ ìƒì£¼ì¸êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°
  total_rspop_sum = filtered_df['ì´ ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()

#í–‰ì •ë™_ì½”ë“œë¡œ ë“¤ì–´ì˜¨ ì…ë ¥ì„ í–‰ì •ë™ëª…ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
  dong_name = df_rs_population[(df_rs_population['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

#í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥
  print(f"{dong_name}ì˜ ì´ ì£¼ê±°ì¸êµ¬ ìˆ˜ëŠ” {total_rspop_sum}ëª… ì…ë‹ˆë‹¤!")

# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
total_rspop(11230545)

# í–‰ì •ë™ë³„ ì£¼ê±°ì¸êµ¬ ìˆ˜(ë¼ì¸ê·¸ë˜í”„)
# input: í–‰ì •ë™ì½”ë“œ
def total_rspop_line(dong_code):
    year_quarter = []
    list_num = []
    for year in  range(2017,2023):
        for quarter in range(1, 5, 1):
            filtered_df = df_rs_population[
            (df_rs_population['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
            (df_rs_population['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) &
            (df_rs_population['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter)
            ]

# ì…ë ¥ëœ í–‰ì •ë™ì½”ë“œë¡œ í–‰ì •ë™ëª… ë„ì¶œí•˜ê¸°
            dong_name = df_rs_population[(df_rs_population['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

# filtered_dfì—ì„œ ì´ ìƒì£¼ì¸êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°
            total_rspop_sum = filtered_df['ì´ ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
            list_num.append(total_rspop_sum)
            year_quarter.append(f'{str(year), str(quarter)}')

# ê·¸ë˜í”„ xì¶•, yì¶•, title, label ì§€ì •
    fig = px.line(x=year_quarter, y=list_num,
                title=f"{dong_name}ì˜ ì´ ì£¼ê±° ì¸êµ¬ ìˆ˜ ë³€í™” ì¶”ì´")

# ê·¸ë˜í”„ ì»¤ìŠ¤í„° ë§ˆì´ì§•
    fig.update_layout(
        xaxis_title="ë¶„ê¸°",
        yaxis_title="ì´ ì£¼ê±° ì¸êµ¬ìˆ˜ ë³€í™”"
    )
# êº¾ì€ì„  ê·¸ë˜í”„ ì¶œë ¥
    return fig.show()

# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
total_rspop_line(11545710)

"""###ë¶„ì„1: ì£¼ê±°ì¸êµ¬ ì„±ë³„, ì—°ë ¹ëŒ€ë³„ 1ìœ„"""

# ì£¼ê±°ì¸êµ¬ ì„±ë³„, ì—°ë ¹ëŒ€ë³„ 1ìœ„
def max_rspop(dong_code):
# í–‰ì •ë™_ì½”ë“œ, ê¸°ì¤€_ë…„_ì½”ë“œ, ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œê°€ ê°™ì€ í–‰ë¼ë¦¬ filtered_df ë°ì´í„°í”„ë ˆì„ ìƒì„±
  filtered_df = df_rs_population[
    (df_rs_population['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
    (df_rs_population['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2022) &
    (df_rs_population['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == 4)
  ]

# filtered_dfì—ì„œ ì„±ë³„, ì—°ë ¹ëŒ€ ì¸êµ¬ìˆ˜ ì´í•© êµ¬í•˜ê¸°
  sum_M_10s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 10 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_M_20s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 20 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_M_30s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 30 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_M_40s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 40 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_M_50s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 50 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_M_60s = filtered_df['ë‚¨ì„±ì—°ë ¹ëŒ€ 60 ì´ìƒ ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_10s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 10 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_20s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 20 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_30s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 30 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_40s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 40 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_50s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 50 ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  sum_W_60s = filtered_df['ì—¬ì„±ì—°ë ¹ëŒ€ 60 ì´ìƒ ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()

# ë”•ì…”ë„ˆë¦¬ ë§Œë“¤ê¸°
  sums = {
    '10ëŒ€ ë‚¨ì„±': sum_M_10s,
    '20ëŒ€ ë‚¨ì„±': sum_M_20s,
    '30ëŒ€ ë‚¨ì„±': sum_M_30s,
    '40ëŒ€ ë‚¨ì„±': sum_M_40s,
    '50ëŒ€ ë‚¨ì„±': sum_M_50s,
    '60ëŒ€ ì´ìƒ ë‚¨ì„±': sum_M_60s,
    '10ëŒ€ ì—¬ì„±': sum_W_10s,
    '20ëŒ€ ì—¬ì„±': sum_W_20s,
    '30ëŒ€ ì—¬ì„±': sum_W_30s,
    '40ëŒ€ ì—¬ì„±': sum_W_40s,
    '50ëŒ€ ì—¬ì„±': sum_W_50s,
    '60ëŒ€ ì´ìƒ ì—¬ì„±': sum_W_60s
  }

# ë”•ì…”ë„ˆë¦¬ì—ì„œ ì„±ë³„, ì—°ë ¹ëŒ€ ì¸êµ¬ìˆ˜ì˜ ì´í•©ì´ ê°€ì¥ í° ì»¬ëŸ¼ êµ¬í•˜ê¸°
  column_with_max_sum = max(sums, key=sums.get)

#í–‰ì •ë™ì½”ë“œë¡œ ë“¤ì–´ì˜¨ ì…ë ¥ì„ í–‰ì •ë™ëª…ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
  dong_name = df_rs_population[(df_rs_population['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

# ë¹„ìœ¨ ì¶”ê°€
  total_rspop_sum = filtered_df['ì´ ìƒì£¼ì¸êµ¬ ìˆ˜'].sum()
  max_ratio = max(sums.values()) / total_rspop_sum

# í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥
  print(f"{dong_name}ëŠ” {column_with_max_sum}ì´ {max_ratio:.2%}ë¡œ ê°€ì¥ ë§ì´ ì‚´ê³  ìˆìŠµë‹ˆë‹¤!")

# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
max_rspop(11545710)

"""###ë¶„ì„2: ì´ ê°€êµ¬ ì„¸ëŒ€ìˆ˜"""

# ì´ ê°€êµ¬ ì„¸ëŒ€ ìˆ˜
# ì´ ê°€êµ¬ ì„¸ëŒ€ ìˆ˜(ë¶„ê¸°ë³„ ë¼ì¸ê·¸ë˜í”„)
def total_household_line(dong_code):
    year_quarter = []
    list_num = []
    for year in  range(2017,2023):
        for quarter in range(1, 5, 1):
            filtered_df = df_rs_population[
            (df_rs_population['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
            (df_rs_population['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) &
            (df_rs_population['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter)
            ]


            # filtered_dfì—ì„œ ì´ ìƒì£¼ì¸êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°
            total_rspop_sum = filtered_df['ì´ ê°€êµ¬ ìˆ˜'].sum()
            list_num.append(total_rspop_sum)
            year_quarter.append(f'{str(year), str(quarter)}')

    dong_name = df_rs_population[(df_rs_population['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

# ê·¸ë˜í”„ xì¶•, yì¶•, title, label ì§€ì •
    fig = px.line(x=year_quarter, y=list_num,
                title=f"{dong_name}ì˜ ì´ ê°€êµ¬ ìˆ˜ ë³€í™” ì¶”ì´")

# ê·¸ë˜í”„ ì»¤ìŠ¤í„° ë§ˆì´ì§•
    fig.update_layout(
        xaxis_title="ë¶„ê¸°",
        yaxis_title="ì´ ê°€êµ¬ ìˆ˜ ë³€í™”"
    )
# êº¾ì€ì„  ê·¸ë˜í”„ ì¶œë ¥
    return fig.show()

# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
total_household_line(11545710)

# ì´ ê°€êµ¬ ì„¸ëŒ€ ìˆ˜(í…ìŠ¤íŠ¸)
# input: í–‰ì •ë™ì½”ë“œ, ê¸°ì¤€ë…„ì½”ë“œ, ê¸°ì¤€ë¶„ê¸°ì½”ë“œ

def total_household(dong_code):
# í–‰ì •ë™_ì½”ë“œ, ê¸°ì¤€_ë…„_ì½”ë“œ, ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œê°€ ê°™ì€ í–‰ë¼ë¦¬ filtered_df ë°ì´í„°í”„ë ˆì„ ìƒì„±
  filtered_df = df_rs_population[
    (df_rs_population['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
    (df_rs_population['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2022) &
    (df_rs_population['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == 4)
]
# filtered_dfì—ì„œ ì´ ê°€êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°
  total_household_sum = filtered_df['ì´ ê°€êµ¬ ìˆ˜'].sum()

# í–‰ì •ë™_ì½”ë“œë¡œ ë“¤ì–´ì˜¨ ì…ë ¥ì„ í–‰ì •ë™ëª…ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
  dong_name = df_rs_population[(df_rs_population['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

# í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥
  print(f"{dong_name}ì˜ ì´ ê°€êµ¬ ìˆ˜ëŠ” {total_household_sum}ì„¸ëŒ€ ì…ë‹ˆë‹¤!")

# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
total_household(11545710)

"""###ë¶„ì„3: í–‰ì •ë™ë³„ ì†Œë“êµ¬ê°„"""

def income_avg(dong_code):
    gu_code = df_rs_income[df_rs_income['í–‰ì •ë™_ì½”ë“œ'] == dong_code]['ì‹œêµ°êµ¬_ì½”ë“œ'].iloc[0]

#í–‰ì •ë™_ì½”ë“œë¡œ ë“¤ì–´ì˜¨ ì…ë ¥ì„ í–‰ì •ë™ëª…ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
    dong_name = df_rs_income[(df_rs_income['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]
    gu_name = df_rs_income[(df_rs_income['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['ì‹œêµ°êµ¬ëª…'].iloc[0]
# ì…ë ¥ëœ dong_codeì— í•´ë‹¹í•˜ëŠ” ì‹œêµ°êµ¬ì½”ë“œ ì°¾ì•„ì„œ ê°™ì€ ì‹œêµ°êµ¬ë§Œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°í”„ë ˆì„ ìƒì„±
    filtered_df = df_rs_income[(df_rs_income['í–‰ì •ë™_ì½”ë“œ'] == dong_code) | (df_rs_income['ì‹œêµ°êµ¬_ì½”ë“œ'] == gu_code)]

# ì†Œë“ê¸ˆì•¡ì„ ì†Œë“êµ¬ê°„ìœ¼ë¡œ ë³€í™˜
    def categorize_income(income):
      income_brackets = [
          (1224311, 1441526),
          (1441527, 1707397),
          (1707398, 2020851),
          (2020852, 2440599),
          (2440600, 2983558),
          (2983559, 3741082),
          (3741083, 4890361),
          (4890362, 6945811),
          (6945812, float('inf'))
      ]

      for i, (lower, upper) in enumerate(income_brackets):
          if lower <= income <= upper:
              return i+2
      return 10
# ë™, êµ¬, ì‹œë³„ í‰ê·  ì†Œë“ê¸ˆì•¡ ê³„ì‚°
    average_income_dong = filtered_df[filtered_df['í–‰ì •ë™_ì½”ë“œ'] == dong_code]['ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡'].mean().round(2)
    average_income_gu= filtered_df[filtered_df['ì‹œêµ°êµ¬_ì½”ë“œ'] == gu_code]['ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡'].mean().round(2)
    average_income_si = df_rs_income['ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡'].mean().round(2)

# Categorize incomes
    categorized_income_dong = categorize_income(average_income_dong)
    categorized_income_gu = categorize_income(average_income_gu)
    categorized_income_si = categorize_income(average_income_si)

# ê·¸ë˜í”„ ìƒ‰ìƒ ì„¤ì •
    colors = ['í–‰ì •ë™í‰ê· ', 'í–‰ì •êµ¬í‰ê· ', 'ì„œìš¸ì‹œí‰ê· ']
    for template in ["simple_white"]:
# ê·¸ë˜í”„ ë§Œë“¤ê¸°
      fig = px.bar(
      x=[f'{dong_name}í‰ê· ', f'{gu_name}í‰ê· ', 'ì„œìš¸ì‹œí‰ê· '],
      y=[categorized_income_dong, categorized_income_gu, categorized_income_si],
      labels={'x': 'ì§€ì—­ ë²”ìœ„', 'y': 'ì†Œë“ êµ¬ê°„'},
      template=template,
      color=colors,
      color_discrete_map={
                "í–‰ì •ë™í‰ê· ": "rgb(190,168,218)",
                "í–‰ì •êµ¬í‰ê· ": "rgb(251,128,114)",
                "ì„œìš¸ì‹œí‰ê· ": "rgb(141,211,199)"
                },
      title=f'{dong_name}ì˜ ì†Œë“ êµ¬ê°„'
      )
# yì¶• ë²”ìœ„ ê³ ì •
    fig.update_yaxes(range=[1, 10])

# ë§‰ëŒ€ ë‘ê»˜ ì¡°ì •
    fig.update_layout(bargap=0.7)

# í…ìŠ¤íŠ¸ ë° ê·¸ë˜í”„ ì¶œë ¥
    fig.show()
    print(f'{dong_name}ì˜ í‰ê·  ì†Œë“ êµ¬ê°„ì€ {categorized_income_dong}ë¶„ìœ„ì…ë‹ˆë‹¤.')


# í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
income_avg(11230545)

"""### ìµœì¢… ë¶„ì„ ì‹¤í–‰"""

summary_rspop(11230545)

"""# ìƒí™œì¸êµ¬

## ìµœì¢… ë¶„ì„
"""

# ì·¨í•©
def analyze_lifepop(year, quarter, dong_code):
  get_lifepop_info(year, quarter, dong_code)
  get_genlifepop_info(year, quarter, dong_code)
  get_lifepop_age(year, quarter, dong_code)
  get_lifepop_time(year, quarter, dong_code)
  get_lifepop_day(year, quarter, dong_code)
  get_lifepop_recent(dong_code)
  get_lifepop_line(dong_code)

"""## ë¶„ì„0: ì´ ìƒí™œì¸êµ¬ìˆ˜, ì´ ìƒí™œì¸êµ¬ìˆ˜ê°€ ë§ì€ ìƒìœ„ ìƒê¶Œ 3ê°œ"""

# ë…„ë„, ë¶„ê¸°, í–‰ì •ë™ ì…ë ¥í•˜ë©´
def get_lifepop_info(year, quarter, dong_code):
    filtered_df = df_lifepop[(df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

    #ì…ë ¥í•œ ê²ƒê³¼ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìœ¼ë©´
    if filtered_df.empty:
        return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    lifepop_value = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()  # ì¡°ê±´ì— ë§ëŠ” ê°’ë“¤ì˜ ì´í•©
    print(f"ì´ ìƒí™œì¸êµ¬ ìˆ˜: {lifepop_value}ëª…")


    # ì»¬ëŸ¼ 'ì´_ìƒí™œì¸êµ¬_ìˆ˜'ê°€ ë§ì€ ìƒìœ„ 3ê°œì˜ 'ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_ì½”ë“œ_ëª…' ê·¸ë¦¬ê³  í•´ë‹¹ ì»¬ëŸ¼ë“¤ì˜ í–‰ ê°’ì„ ì¶œë ¥
    top_lifepop = filtered_df.nlargest(3, 'ì´_ìƒí™œì¸êµ¬_ìˆ˜')[['ìƒê¶Œ_ì½”ë“œ', 'ìƒê¶Œ_ì½”ë“œ_ëª…', 'ì´_ìƒí™œì¸êµ¬_ìˆ˜']]

    print("ì´ ìƒí™œì¸êµ¬ ìˆ˜ê°€ ë§ì€ ìƒìœ„ ìƒê¶Œ ì •ë³´:")
    for index, row in top_lifepop.iterrows():
        code = row['ìƒê¶Œ_ì½”ë“œ']
        name = row['ìƒê¶Œ_ì½”ë“œ_ëª…']
        lifepop = row['ì´_ìƒí™œì¸êµ¬_ìˆ˜']
        print(f"ìƒê¶Œ ì½”ë“œ: {code}, ìƒê¶Œëª…: {name}, ìƒí™œì¸êµ¬ ìˆ˜: {lifepop}ëª…")
# ê·¸ë˜í”„ ìƒ‰ìƒ ì„¤ì •
    colors = ['í–‰ì •ë™í‰ê· ', 'í–‰ì •êµ¬í‰ê· ', 'ì„œìš¸ì‹œí‰ê· ']
    for template in ["simple_white"]:
    # plotlyë¥¼ ì‚¬ìš©í•˜ì—¬ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
      fig = px.bar(top_lifepop, x='ìƒê¶Œ_ì½”ë“œ_ëª…', y='ì´_ìƒí™œì¸êµ¬_ìˆ˜', title='ìƒìœ„ ìƒê¶Œ ì½”ë“œë³„ ìƒí™œì¸êµ¬ ìˆ˜',
                 template=template,
                 color=colors,
                 color_discrete_map={
                "í–‰ì •ë™í‰ê· ": "rgb(190,168,218)",
                "í–‰ì •êµ¬í‰ê· ": "rgb(251,128,114)",
                "ì„œìš¸ì‹œí‰ê· ": "rgb(141,211,199)"
                })
    fig.update_layout(bargap=0.7)
    fig.show()

get_lifepop_info(2022, 4, 11680580) # í–‰ì •ë™ì— ìˆëŠ” ìƒê¶Œë“¤ì˜ ì´ ìƒí™œì¸êµ¬ ìˆ˜ & ìƒìœ„ 3ê°œ ìƒê¶Œ

"""##ë¶„ì„1: í•´ë‹¹ í–‰ì •ë™ì—ì„œ ê°€ì¥ ë§ì€ ì„±ë³„(ìˆ˜, ë¹„ìœ¨)"""

def get_genlifepop_info(year, quarter, dong_code):
    filtered_df = df_lifepop[(df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

    if filtered_df.empty:
        return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    # 1. 'ì´_ìƒí™œì¸êµ¬_ìˆ˜'ì˜ í•´ë‹¹ í–‰ ê°’ì—ì„œ 'ë‚¨ì„±_ìƒí™œì¸êµ¬_ìˆ˜'ì™€ 'ì—¬ì„±_ìƒí™œì¸êµ¬_ìˆ˜'ì˜ ë¹„ìœ¨ ì¶œë ¥
    male_lifepop = filtered_df['ë‚¨ì„±_ìƒí™œì¸êµ¬_ìˆ˜'].sum()
    female_lifepop = filtered_df['ì—¬ì„±_ìƒí™œì¸êµ¬_ìˆ˜'].sum()
    total_lifepop = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()

    male_ratio = male_lifepop / total_lifepop
    female_ratio = female_lifepop / total_lifepop

    # ë°±ë¶„ìœ¨ë¡œ í‘œì‹œí•  ë•Œ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë‚˜íƒ€ëƒ„
    print(f"í•´ë‹¹ í–‰ì •ë™ì˜ ì„±ë¹„\në‚¨ì„± ë¹„ìœ¨: {male_ratio:.2%}, ì—¬ì„± ë¹„ìœ¨: {female_ratio:.2%}")

    # 2. 'ë‚¨ì„±_ìƒí™œì¸êµ¬_ìˆ˜'ì˜ í•´ë‹¹ í–‰ ê°’ì—ì„œ 'ì—¬ì„±_ìƒí™œì¸êµ¬_ìˆ˜'ì˜ í•´ë‹¹ í–‰ ê°’ì„ ëºì„ ë•Œ,
    # ê°’ì´ ìŒìˆ˜ê°€ ë‚˜ì˜¤ë©´ 'ì—¬ì„±'ì„ ì¶œë ¥í•˜ê³  ì–‘ìˆ˜ê°€ ë‚˜ì˜¤ë©´ 'ë‚¨ì„±'ì„ ì¶œë ¥
    gender_difference = male_lifepop - female_lifepop

    if gender_difference < 0:
        gender_result = "ì—¬ì„±"
        lifepop_gender_value = filtered_df['ì—¬ì„±_ìƒí™œì¸êµ¬_ìˆ˜'].sum()
    else:
        gender_result = "ë‚¨ì„±"
        lifepop_gender_value = filtered_df['ë‚¨ì„±_ìƒí™œì¸êµ¬_ìˆ˜'].sum()

    # ë‚¨ì„±ê³¼ ì—¬ì„± ë¹„ìœ¨ì„ íŒŒì´ì°¨íŠ¸ë¡œ ì‹œê°í™”

    gender_ratio_data = pd.DataFrame({'ì„±ë³„': ['ë‚¨ì„±', 'ì—¬ì„±'], 'ë¹„ìœ¨': [male_ratio, female_ratio]})
    fig = px.pie(gender_ratio_data, values='ë¹„ìœ¨', names='ì„±ë³„', title=f"{year}ë…„ {quarter}ë¶„ê¸° í–‰ì •ë™ ì½”ë“œ{dong_code}ì˜ ë‚¨ì„±/ì—¬ì„± ë¹„ìœ¨")
    fig.show()

    print(f"í•´ë‹¹ í–‰ì •ë™ì˜ ìƒí™œì¸êµ¬ëŠ” {gender_result}ì´ ë§ìŠµë‹ˆë‹¤.")
    print(f"{gender_result}ì˜ ìƒí™œì¸êµ¬ ìˆ˜: {lifepop_gender_value}ëª…")

# ì‚¬ìš© ì˜ˆì‹œ
get_genlifepop_info(2022, 4, 11680580)

"""##ë¶„ì„2: í•´ë‹¹ í–‰ì •ë™ì—ì„œ ê°€ì¥ ë§ì€ ì—°ë ¹ëŒ€, ì—°ë ¹ëŒ€ë³„ ë¹„ìœ¨
(ë¹„ìœ¨ ë°˜ì˜¬ë¦¼í•¨)
"""

def get_lifepop_age(year, quarter, dong_code):
    # ì»¬ëŸ¼ëª… ë³€ê²½
    df_lifepop.rename(columns={
          'ì—°ë ¹ëŒ€_10_ìƒí™œì¸êµ¬_ìˆ˜': '10ëŒ€',
          'ì—°ë ¹ëŒ€_20_ìƒí™œì¸êµ¬_ìˆ˜': '20ëŒ€',
          'ì—°ë ¹ëŒ€_30_ìƒí™œì¸êµ¬_ìˆ˜': '30ëŒ€',
          'ì—°ë ¹ëŒ€_40_ìƒí™œì¸êµ¬_ìˆ˜': '40ëŒ€',
          'ì—°ë ¹ëŒ€_50_ìƒí™œì¸êµ¬_ìˆ˜': '50ëŒ€',
          'ì—°ë ¹ëŒ€_60_ì´ìƒ_ìƒí™œì¸êµ¬_ìˆ˜': '60ëŒ€ì´ìƒ'}, inplace=True)
    # í•´ë‹¹ ì—°ë„, ë¶„ê¸°, ë™ ì½”ë“œì— ë§ëŠ” ë°ì´í„° ì¶”ì¶œ
    filtered_df = df_lifepop[(df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

    if filtered_df.empty:
        return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    age_columns = ['10ëŒ€', '20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€ì´ìƒ']

    # ì—°ë ¹ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜ì˜ ë¹„ìœ¨ ê³„ì‚°
    total_lifepop = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()
    ratios = filtered_df[age_columns] / total_lifepop
    data_lifeage = pd.DataFrame(ratios.sum())

    # ê°€ì¥ í° ë¹„ìœ¨ ê°’ì„ ê°€ì§„ ì»¬ëŸ¼ ì°¾ê¸° :í•´ë‹¹ í–‰ì—ì„œ ê°€ì¥ í° ë¹„ìœ¨ì„ ê°€ì§„ ì—°ë ¹ëŒ€ë¥¼ í™•ì¸í•˜ê³  ê·¸ ë¹„ìœ¨ ê°’ ì°¾ê¸°
    max_ratio_gender_column = ratios.idxmax(axis=1) # idxmax() í•¨ìˆ˜ -> ì£¼ì–´ì§„ ì¶•(axis)ì„ ë”°ë¼ ê°€ì¥ í° ê°’ì„ ê°€ì§€ëŠ” ì—´ì˜ ì¸ë±ìŠ¤ë¥¼ ë°˜í™˜!!
    max_ratio_gender_value = ratios.max(axis=1).sum()

    # ì†Œìˆ˜ì  ë¹„ìœ¨ì„ ì •ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ì¶œë ¥
    max_ratio_gender_value_percentage = int(max_ratio_gender_value * 100)  # ë¹„ìœ¨ì„ ë°±ë¶„ìœ¨ë¡œ í‘œí˜„í•˜ê¸° ìœ„í•´ 100ì„ ê³±í•˜ê³  ì •ìˆ˜ë¡œ ë³€í™˜


    # Plotly íŒŒì´ì°¨íŠ¸ ìƒì„±
    fig = px.pie(data_lifeage,values=data_lifeage[0], names=data_lifeage.index,
        title=f"ì—°ë ¹ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜ì˜ ë¹„ìœ¨ ({year}ë…„ {quarter}ë¶„ê¸°, ë™ ì½”ë“œ: {dong_code})"
    )

    fig.show()  # ê·¸ë˜í”„ ê°ì²´ ë°˜í™˜

    print(f"í•´ë‹¹ í–‰ì •ë™ì— ê°€ì¥ ë§ì€ ì—°ë ¹ëŒ€({max_ratio_gender_value_percentage}%): {max_ratio_gender_column.values[0]}")

get_lifepop_age(2022, 4, 11680580)

"""## ë¶„ì„3: í•´ë‹¹ í–‰ì •ë™ì— ìƒí™œì¸êµ¬ê°€ ë§ì´ ìˆëŠ” ì‹œê°„ëŒ€"""

def get_lifepop_time(year, quarter, dong_code):
    # ì»¬ëŸ¼ëª… ë³€ê²½
    df_lifepop.rename(columns={
        'ì‹œê°„ëŒ€_1_ìƒí™œì¸êµ¬_ìˆ˜': '00~06ì‹œ',
        'ì‹œê°„ëŒ€_2_ìƒí™œì¸êµ¬_ìˆ˜': '06~11ì‹œ',
        'ì‹œê°„ëŒ€_3_ìƒí™œì¸êµ¬_ìˆ˜': '11~14ì‹œ',
        'ì‹œê°„ëŒ€_4_ìƒí™œì¸êµ¬_ìˆ˜': '14~17ì‹œ',
        'ì‹œê°„ëŒ€_5_ìƒí™œì¸êµ¬_ìˆ˜': '17~21ì‹œ',
        'ì‹œê°„ëŒ€_6_ìƒí™œì¸êµ¬_ìˆ˜': '21~24ì‹œ'}, inplace=True)

    filtered_df = df_lifepop[(df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

    if filtered_df.empty:
        return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    # ê° ì‹œê°„ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜ ì»¬ëŸ¼ ì„ íƒ
    lifepop_time_columns = ['00~06ì‹œ', '06~11ì‹œ', '11~14ì‹œ', '14~17ì‹œ', '17~21ì‹œ', '21~24ì‹œ']

    # ê° ì‹œê°„ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜ì˜ ì´í•© ê³„ì‚°
    total_population = filtered_df[lifepop_time_columns].sum()

    # ê²°ê³¼ ì¶œë ¥
    print("ê° ì‹œê°„ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜:")
    for col, total in total_population.items():
        print(f"{col}: {total}")

    # ê°€ì¥ í° ì´í•©ì„ ê°€ì§„ ì»¬ëŸ¼ëª… ì¶œë ¥
    max_column = total_population.idxmax()

    # ê²°ê³¼ë¥¼ ê·¸ë˜í”„ë¡œ í‘œì‹œ
    fig = px.line(x=total_population.index, y=total_population.values, labels={'x': 'ì‹œê°„ëŒ€', 'y': 'ìƒí™œì¸êµ¬ ìˆ˜'},color_discrete_sequence=['red'],markers=True)
    fig.update_layout(title=f"{year}ë…„ {quarter}ë¶„ê¸° {dong_code} í–‰ì •ë™ì˜ ê° ì‹œê°„ëŒ€ë³„ ìƒí™œì¸êµ¬ ìˆ˜",xaxis_tickangle=-45)

    fig.show()
    print(f"\nìƒí™œì¸êµ¬ê°€ ê°€ì¥ ë§ì€ ì‹œê°„ëŒ€: {max_column}")

get_lifepop_time(2022, 4, 11680580)

"""##ë¶„ì„4: í•´ë‹¹ í–‰ì •ë™ì˜ ìš”ì¼ë³„ ìƒí™œì¸êµ¬"""

def get_lifepop_day(year, quarter, dong_code):
    # ì»¬ëŸ¼ëª… ë³€ê²½
    df_lifepop.rename(columns={
        'ì›”ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'ì›”ìš”ì¼',
        'í™”ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'í™”ìš”ì¼',
        'ìˆ˜ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'ìˆ˜ìš”ì¼',
        'ëª©ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'ëª©ìš”ì¼',
        'ê¸ˆìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'ê¸ˆìš”ì¼',
        'í† ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜': 'í† ìš”ì¼',
    'ì¼ìš”ì¼_ìƒí™œì¸êµ¬_ìˆ˜':'ì¼ìš”ì¼'}, inplace=True)
    # ì¡°ê±´ì— ë§ëŠ” ë°ì´í„° í•„í„°ë§
    filtered_df = df_lifepop[(df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

    if filtered_df.empty:
        return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    day_columns = ['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼']

    # ê° ìš”ì¼ë³„ ìƒí™œì¸êµ¬ ìˆ˜ì˜ ì´í•© ê³„ì‚°
    total_per_day = filtered_df[day_columns].sum()
    print(f"\nê° ìš”ì¼ë³„ ìƒí™œì¸êµ¬ ìˆ˜ì˜ ì´í•©:\n{total_per_day}ëª…")

    # ê°€ì¥ í° ì´í•©ì„ ê°€ì§„ ìš”ì¼ ì°¾ê¸°
    max_day = total_per_day.idxmax()
    print(f"\nê°€ì¥ ìƒí™œì¸êµ¬ê°€ ë§ì€ ìš”ì¼:{max_day}")


    # ìš”ì¼ë³„ ë¹„ìœ¨ ê³„ì‚°
    mon_lifepop = filtered_df['ì›”ìš”ì¼'].sum()
    tue_lifepop = filtered_df['í™”ìš”ì¼'].sum()
    wed_lifepop = filtered_df['ìˆ˜ìš”ì¼'].sum()
    thu_lifepop = filtered_df['ëª©ìš”ì¼'].sum()
    fri_lifepop = filtered_df['ê¸ˆìš”ì¼'].sum()
    sat_lifepop = filtered_df['í† ìš”ì¼'].sum()
    sun_lifepop = filtered_df['ì¼ìš”ì¼'].sum()
    total_lifepop = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()

    mon_ratio = mon_lifepop / total_lifepop
    tue_ratio = tue_lifepop / total_lifepop
    wed_ratio = wed_lifepop / total_lifepop
    thu_ratio = thu_lifepop / total_lifepop
    fri_ratio = fri_lifepop / total_lifepop
    sat_ratio = sat_lifepop / total_lifepop
    sun_ratio = sun_lifepop / total_lifepop

    # ë°±ë¶„ìœ¨ë¡œ í‘œì‹œí•  ë•Œ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë‚˜íƒ€ëƒ„
    print(f"\ní•´ë‹¹ í–‰ì •ë™ì˜ ìš”ì¼ ë¹„ìœ¨\n"
         f"ì›”: {mon_ratio:.0%}\n"
          f"í™”: {tue_ratio:.0%}\n"
          f"ìˆ˜: {wed_ratio:.0%}\n"
          f"ëª©: {thu_ratio:.0%}\n"
          f"ê¸ˆ: {fri_ratio:.0%}\n"
          f"í† : {sat_ratio:.0%}\n"
          f"ì¼: {sun_ratio:.0%}")


    # ê° ìš”ì¼ë³„ ìƒí™œì¸êµ¬ ìˆ˜ ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    day_labels = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
    fig_bar = px.bar(x=day_labels, y=total_per_day, labels={'x': 'ìš”ì¼', 'y': 'ìƒí™œì¸êµ¬ ìˆ˜'}, title='ê° ìš”ì¼ë³„ ìƒí™œì¸êµ¬ ìˆ˜')
    fig_bar.show()

    # í–‰ì •ë™ì˜ ìš”ì¼ ë¹„ìœ¨ íŒŒì´ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    ratios = [mon_ratio, tue_ratio, wed_ratio, thu_ratio, fri_ratio, sat_ratio, sun_ratio]
    data2 = pd.DataFrame(zip(day_labels, ratios), columns=['ìš”ì¼', 'ë¹„ìœ¨'])
    # íŒŒì´ì°¨íŠ¸ ìš”ì¼ ìˆœì„œëŒ€ë¡œ ì¶œë ¥í•˜ê¸°
    fig_pie = px.pie(data2, names='ìš”ì¼', values='ë¹„ìœ¨', title='í–‰ì •ë™ì˜ ìš”ì¼ ë¹„ìœ¨',category_orders={'ìš”ì¼':['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']})
    fig_pie.show()

get_lifepop_day(2022, 4, 11680580)

"""## ë¶„ì„5: ìµœê·¼ ë…„ë„ ë¶„ê¸°ì˜ ì´ ìƒí™œì¸êµ¬ìˆ˜
dong_codeì…ë ¥í•˜ë©´ ìµœê·¼ ë°ì´í„°(2022ë…„ë„ 4ë¶„ê¸°)
"""

def get_lifepop_recent(dong_code):
    filtered_df = df_lifepop[
    (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
    (df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2022) &
    (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == 4)]


    # filtered_dfì—ì„œ ì´ ìƒì£¼ì¸êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°

    total_lifepop = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()


    print(f"{total_lifepop}ëª…")

get_lifepop_recent(11680580)

"""## ë¶„ì„6: í•´ë‹¹ í–‰ì •ë™ ì´ ìƒí™œì¸êµ¬ ìˆ˜ ë³€í™”"""

def get_lifepop_line(dong_code):
    year_quarter = []
    list_num = []
    for year in  range(2017,2023):
        for quarter in range(1, 5):
            filtered_df = df_lifepop[
            (df_lifepop['í–‰ì •ë™_ì½”ë“œ'] == dong_code) &
            (df_lifepop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) &
            (df_lifepop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter)]

# ì…ë ¥ëœ í–‰ì •ë™ì½”ë“œë¡œ í–‰ì •ë™ëª… ë„ì¶œí•˜ê¸°
            dong_name = df_lifepop[(df_lifepop['í–‰ì •ë™_ì½”ë“œ']==dong_code)]['í–‰ì •ë™ëª…'].iloc[0]

# filtered_dfì—ì„œ ì´ ìƒí™œì¸êµ¬ ìˆ˜ ì´í•© êµ¬í•˜ê¸°
            lifepop_value = filtered_df['ì´_ìƒí™œì¸êµ¬_ìˆ˜'].sum()
            list_num.append(lifepop_value)
            year_quarter.append(f'{str(year), str(quarter)}')

# ê·¸ë˜í”„ xì¶•, yì¶•, title, label ì§€ì •
    fig = px.line(x=year_quarter, y=list_num,
                title=f"{dong_name}ì˜ ì´ ìƒí™œì¸êµ¬ ìˆ˜ ë³€í™”",color_discrete_sequence=['black'],markers=True)

# ê·¸ë˜í”„ ì»¤ìŠ¤í„° ë§ˆì´ì§•
    fig.update_layout(
        xaxis_title="ë¶„ê¸°",
        yaxis_title="ì´ ìƒí™œì¸êµ¬ ìˆ˜ ë³€í™”"
    )
# êº¾ì€ì„  ê·¸ë˜í”„ ì¶œë ¥
    return fig.show()

get_lifepop_line(11680580)

"""# ì§ì¥ì¸êµ¬

## ë¶„ì„0:í•´ë‹¹ í–‰ì •ë™ì˜ ì´ ì§ì¥ì¸êµ¬ ìˆ˜, ì´ ì§ì¥ì¸êµ¬ê°€ ë§ì€ ìƒìœ„ 3ê°œ ìƒê¶Œ
"""

def get_workpop_info(year, quarter, dong_code):
  filtered_df = df_workpop[(df_workpop['ê¸°ì¤€_ë…„_ì½”ë“œ'] == year) & (df_workpop['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] == quarter) & (df_workpop['í–‰ì •ë™_ì½”ë“œ'] == dong_code)]

  if filtered_df.empty:
     return "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

  workpop_value = filtered_df['ì´_ì§ì¥ì¸êµ¬_ìˆ˜'].sum()
  print(f"ì´ ì§ì¥ì¸êµ¬ ìˆ˜: {workpop_value}ëª…")

  top_workpop = filtered_df.nlargest(3, 'ì´_ì§ì¥ì¸êµ¬_ìˆ˜')[['ìƒê¶Œ_ì½”ë“œ','ìƒê¶Œ_ì½”ë“œ_ëª…','ì´_ì§ì¥ì¸êµ¬_ìˆ˜']]
  print("ì´ ì§ì¥ì¸êµ¬ ìˆ˜ê°€ ë§ì€ ìƒìœ„ ìƒê¶Œ ì •ë³´:")
  for index, row in top_workpop.iterrows():
     code = row['ìƒê¶Œ_ì½”ë“œ']
     name = row['ìƒê¶Œ_ì½”ë“œ_ëª…']
     workpop = row['ì´_ì§ì¥ì¸êµ¬_ìˆ˜']
     print(f"ìƒê¶Œ ì½”ë“œ: {code}, ìƒê¶Œëª…:{name}, ì§ì¥ì¸êµ¬ ìˆ˜:{workpop}ëª…")

  fig = px.bar(top_workpop, x='ìƒê¶Œ_ì½”ë“œ_ëª…', y='ì´_ì§ì¥ì¸êµ¬_ìˆ˜', title='ìƒìœ„ ìƒê¶Œ ì½”ë“œë³„ ì§ì¥ì¸êµ¬ ìˆ˜',color_discrete_sequence=['green'])
  fig.update_layout(bargap=0.7)
  fig.show()

get_workpop_info(2022, 4, 11680580)

"""#ì „ì²´ ì·¨í•©"""

def analyze_final(year, quarter, dong_code, job_code):
  global df_map_info

  analyze_env(dong_code, job_code)

  analyze_sales(dong_code, year, quarter)

  analyze_pop(year, quarter, dong_code)

  analyze_apt(dong_code)

analyze_final(2022, 4, 11680580, 'ì„œë¹„ìŠ¤ì—…')